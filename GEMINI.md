# MindSpark AI Study Assistant - Project Context

## 0. Critical Protocols (鐵規)
*   **Protocol: CHECKLIST_FIRST**: Must maintain and update `CHECKLIST.md` for every major task.
*   **Protocol: LANGUAGE_ZH_TW**: All interactions and responses MUST be in Traditional Chinese (繁體中文).

## 1. Project Overview

**MindSpark** is a React-based Single Page Application (SPA) designed to be an AI-powered study companion. It acts as a client-side interface for managing and practicing with question banks generated by Large Language Models (LLMs) like Gemini, ChatGPT, or Claude.

*   **Type:** Frontend Web Application (React + Vite + TypeScript).
*   **Core Philosophy:** "Human-in-the-loop" AI integration. The app does not call AI APIs directly (currently); instead, it provides optimized prompts for users to generate content externally and import it as structured JSON.
*   **Styling:** Tailwind CSS (inferred from utility classes).
*   **Icons:** `lucide-react`.

## 2. Architecture & Design Patterns

### 2.1 State Management & Persistence
The application uses a **Serverless/Local-First** architecture with a **Repository Pattern**.
*   **Database:** `localStorage` (Guest) or `Supabase` (Auth User).
*   **Repository Layer:** `IStorageRepository` unifies data access.
    *   `LocalStorageRepository`: Handles guest data via `localStorage`.
    *   `CloudStorageRepository`: Handles auth data via `Supabase`.
*   **Context:** `RepositoryContext` provides the correct repository instance based on auth state.
*   **Component State:** React `useState`, `useReducer`, and custom hooks (`useQuizEngine`, `useAppDataLoader`) manage runtime session.

### 2.2 Routing
*   **Custom View Router:** The app does *not* use `react-router`. Navigation is handled via a `view` state in `App.tsx` (`dashboard` | `quiz` | `mistakes` | `manager` | `guide`).

### 2.3 AI Workflow
1.  **Prompting:** User goes to "AI 指引" (`AIPromptGuide.tsx`) to copy a structured prompt.
2.  **Generation:** User generates questions in an external LLM (Gemini/ChatGPT).
3.  **Import:** User pastes the JSON output into "題庫管理" (`BankManager.tsx`).
4.  **Practice:** Questions are stored locally and available for quizzes.

## 3. Key Data Structures (`types.ts`)

*   **`Question`:** The core unit. Supports `single` and `multiple` choice. Includes `hint` and `explanation`.
*   **`BankMetadata`:** Light interface for listing banks (ID, name, count) without loading full datasets.
*   **`MistakeLog`:** Tracks question IDs that were answered incorrectly, enabling "Mistake Review Mode".

## 4. Development & Commands

### Prerequisites
*   Node.js (v18+ recommended)

### Scripts (`package.json`)
*   `npm install`: Install dependencies.
*   `npm run dev`: Start the local development server (Vite).
*   `npm run build`: Build for production (`dist/` folder).
*   `npm run preview`: Preview the production build.

## 5. Directory Structure
*   `App.tsx`: Main entry point, layout, and routing logic.
*   `components/`: UI Components.
    *   `Dashboard.tsx`: Home screen, bank selection.
    *   `QuizCard.tsx`: The actual quiz interface.
    *   `BankManager.tsx`: CRUD for banks and JSON import/export logic.
    *   `AIPromptGuide.tsx`: Dynamic AI Prompt Builder with configurable options (type, language).
    *   `GlobalModals.tsx`: Centralized modal management.
*   `contexts/`: Global state contexts (Auth, Theme, Toast, Repository).
*   `hooks/`: Custom hooks (Business Logic).
    *   `useQuizEngine.ts`: Core quiz logic.
    *   `useAppDataLoader.ts`: Initial data fetching.
*   `reducers/`: State reducers.
    *   `appReducer.ts`: Main app state reducer.
*   `services/`: Business logic.
    *   `repository.ts`: Interface for storage operations.
    *   `storage.ts`: The "backend" (CRUD operations for localStorage).
*   `types.ts`: TypeScript definitions (Schema).
*   `constants.ts`: Global constants (Default questions, App Name).

## 6. Important Notes for Context7/Gemini
*   **No Backend API:** Do not assume existence of a `/api` endpoint. All data is local.
*   **JSON Strictness:** The `BankManager` implies strict JSON structure for imports. When debugging import issues, check `BankManager.tsx`'s validation logic.
*   **Tailwind:** Use Tailwind classes for styling changes.

## 7. Recent Changes (v0.3.5)
*   **Security & Tech Stack (v0.3.6)**:
    - **Tailwind CSS v4**: Migrated from v3/CDN to v4 local integration with Vite plugin.
    - **Security First**: Implemented CSP and removed all external scripts/styles from unreliable CDNs.
    - **Visual Fix**: Corrected theme color definitions to ensure contrast compliance and visibility on light backgrounds.
*   **Battle Mode Bugfixes**:
    *   **Meteor Skill**: Fixed image not displaying by changing `animationType` from `sequence` to `css`.
    *   **Skill Milestones**: Skills now trigger only at level-up milestones (5, 10, 20, 30, 40, 50), not every 5 streaks (15, 25, 35, 45 no longer trigger).
    *   **Damage Balance**: Extended shield mechanism to all monster types (Normal: max 70%, Elite: max 50%, Boss: max 40% damage per hit).
    *   **Skeleton Wizard Scale**: Increased `visualScale` from 1.5 to 1.8 for more imposing appearance.
*   **Dashboard UX Polish (v0.3.4)**:
    *   **Interactive Achievements**: Full details accessible via modal on dashboard.
    *   **Recent Mistakes Card**: Added tracking of last 5 incorrect sessions with quick practice access.
    *   **Quiz Flow**: Default question size set to "All", custom rest interval support.
*   **Battle Mode Overhaul (v0.3.3)**: Complete refactoring of `useBattleSystem` and `QuizResult`.
*   **Quiz UX Enhancements**:
    *   **QuizResult**: New detailed summary page with Mistake Review and Analytics.
    *   **Focus & Usability**: Introduced `MiniTimer`, `RestBreakModal`, `ResumePrompt` (restore confirm), and keyboard shortcut indicators.
    *   **Dashboard Improvements**: Added "Select All" bank toggle and default select all logic.
    *   **Settings**: Added configurable "Rest Break Interval" (20/30/Off).
    *   **Persistence**: Implemented auto-save/restore for active quiz sessions and battle state via `localStorage`.
*   **System Integrity**: Expanded "Root Out" functionality in `App.tsx`/`storage.ts` to ensure clean state resets, including session clearing.
*   **Accessibility**: Fixed ARIA label issues in new components and updated SVG animations to use Tailwind classes.

*   **Skills-Based Optimization (v0.3.7)**:
    *   **AI**: Improved JSON robustness with schema enforcement and few-shot prompting (`services/ai.ts`).
    *   **Performance**: Optimized `Dashboard` rendering by stabilizing props and fixing duplicate updates (`App.tsx`).
    *   **Battle System**: Added DEV mode state logging (`useBattleSystem`) and unit tests for skill triggers (`src/__tests__/useBattleSystem.test.ts`).
    *   **Security**: Validated app security (NPM audit: Clean, No XSS risks).
*   **基礎建設與安全強化 (v0.3.8)**:
    - **Toast/Confirm 系統**：統一通知與確認流程，改善使用者回饋。
    - **ErrorBoundary**：新增全域錯誤攔截，避免 UI 直接崩潰。
    - **型別安全修正**：補強型別檢查與邊界處理。
    - **CSP 強化**：進一步收斂資源來源規則。
    - **Repository 基礎架構**：導入 `IStorageRepository`、本地/雲端 repository 與 `RepositoryContext`。
    - **導覽重構**：抽離 `AppHeader` 與 `MobileNav` 元件。
*   **測試狀態**：因 shell/pwsh 不可用，未執行測試與建置。

*   **Architecture Quality Overhaul (v0.3.9)**:
    - **App Decomposition**: Extracted `appReducer`, `useAppDataLoader`, and `GlobalModals` to reduce monolith size.
    - **Unified Data**: Centralized data loading logic.
    - **Maintainability**: Improved code structure for better readability and testing.

*   **Console Purity & Stability (v0.3.10)**:
    - **Favicon Fix**: Added SVG favicon and linked in `index.html` to resolve 404 errors.
    - **Supabase Fix**: Refactored `getMyChallenges` to use a manual join strategy, eliminating the 400 Bad Request error caused by ambiguous foreign keys.
    - **Spec Sync**: Synchronized console warning fixes into the `social-sharing` main specification via OpenSpec workflow.

